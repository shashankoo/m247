define(['Magento_Ui/js/modal/alert','Magento_Ui/js/modal/confirm','jquery','mage/translate','jquery-ui-modules/widget','mage/validation'],function(alert,confirm,$,$t){'use strict';$.widget('mage.updateShoppingCart',{options:{validationURL:'',eventName:'updateCartItemQty',updateCartActionContainer:'',isCartHasUpdatedContent:false},_create:function(){this._on(this.element,{'submit':this.onSubmit});this._on('[data-role=cart-item-qty]',{'change':function(){this.isCartHasUpdatedContent=true;}});this._on('ul.pages-items',{'click a':function(event){if(this.isCartHasUpdatedContent){event.preventDefault();this.changePageConfirm($(event.currentTarget).attr('href'));}}});},changePageConfirm:function(nextPageUrl){confirm({title:$t('Are you sure you want to leave the page?'),content:$t('Changes you made to the cart will not be saved.'),actions:{confirm:function(){window.location.href=nextPageUrl;}},buttons:[{text:$t('Cancel'),class:'action-secondary action-dismiss',click:function(event){this.closeModal(event);}},{text:$t('Leave'),class:'action-primary action-accept',click:function(event){this.closeModal(event,true);}}]});},onSubmit:function(event){var action=this.element.find(this.options.updateCartActionContainer).val();if(!this.options.validationURL||action==='empty_cart'){return true;}
if(this.isValid()){event.preventDefault();this.validateItems(this.options.validationURL,this.element.serialize());}
return false;},isValid:function(){return this.element.validation()&&this.element.validation('isValid');},validateItems:function(url,data){$.extend(data,{'form_key':$.mage.cookies.get('form_key')});$.ajax({url:url,data:data,type:'post',dataType:'json',context:this,beforeSend:function(){$(document.body).trigger('processStart');},complete:function(){$(document.body).trigger('processStop');}}).done(function(response){if(response.success){this.onSuccess();}else{this.onError(response);}}).fail(function(){this.submitForm();});},onSuccess:function(){$(document).trigger('ajax:'+this.options.eventName);this.submitForm();},onError:function(response){var that=this,elm,responseData=[];try{responseData=JSON.parse(response['error_message']);}catch(error){}
if(response['error_message']){try{$.each(responseData,function(index,data){if(data.itemId!==undefined){elm=$('#cart-'+data.itemId+'-qty');elm.val(elm.attr('data-item-qty'));}
response['error_message']=data.error;});}catch(e){}
alert({content:response['error_message'],actions:{always:function(){that.submitForm();}}});}else{this.submitForm();}},submitForm:function(){this.element.off('submit',this.onSubmit).on('submit',function(){$(document.body).trigger('processStart');}).trigger('submit');}});return $.mage.updateShoppingCart;});